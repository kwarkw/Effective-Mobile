# Задание 3 - Архитектура отправки push-уведомлений (микросервисы)

Цель: описать верхнеуровневую схему отправки push-уведомлений в мобильное приложение интернет-магазина, когда бизнес-логика находится в разных микросервисах.

Схема дана в Mermaid: diagrams/push_architecture.mmd

## 1) Компоненты

### Источники событий (доменные микросервисы)
Примеры:
- orders-service (создание/оплата/статусы заказа)
- delivery-service (статусы доставки)
- marketing-service (промо, рассылки)
- cart-service (брошенная корзина)
Эти сервисы не отправляют пуши напрямую.

### Event bus / брокер сообщений (Kafka или RabbitMQ)
Нужен для надежной доставки событий, разгрузки доменных сервисов и нормальной обработки пиков.

### notification-service (единый сервис уведомлений)
Функции:
- потребляет события из брокера,
- решает, нужно ли уведомление (правила, фильтры),
- выбирает шаблон,
- добавляет персонализацию,
- проверяет настройки пользователя (согласие, язык, тихие часы),
- формирует push-request и отправляет в push-gateway,
- фиксирует результат (успех/ошибка).

### device-token-service
Хранит токены устройств (apns/fcm), привязку токена к user_id, платформу, время последнего обновления.
Токены обновляются приложением при установке/логине/обновлении токена.

### push-gateway
Тонкий слой, который отправляет в APNs/FCM, делает ретраи на сетевые ошибки, учитывает rate limit, пишет метрики.

### Провайдеры
- APNs (iOS)
- FCM (Android)

## 2) Поток (пример: заказ оплачен)
1. orders-service публикует событие order_paid в брокер.
2. notification-service получает событие и маппит на сценарий "Заказ оплачен".
3. notification-service получает токены пользователя из device-token-service.
4. notification-service формирует payload (title/body, deeplink, order_id).
5. push-gateway отправляет в APNs/FCM.
6. notification-service фиксирует статус отправки и ошибки.

## 3) Что важно проговорить на собеседовании
- Идемпотентность: одно событие не должно привести к нескольким одинаковым пушам (dedup по event_id + user_id + scenario).
- Ретраи: временные ошибки - повторяем с backoff; постоянные ошибки (invalid token) - инвалидируем токен.
- Согласия и тихие часы: отправка только при opt-in и с учетом quiet hours (или откладываем).
- Масштабирование: notification-service и push-gateway масштабируются горизонтально; брокер сглаживает пики.
- Наблюдаемость: метрики (send_rate, error_rate, retry_count), логи с корреляцией по event_id.
